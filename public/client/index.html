<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CloudBlinker | タスク詳細</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="/assets/css/tailwind.css" />
  <script src="/assets/js/env.js"></script>
</head>
<body class="min-h-screen bg-slate-50">
  <!-- ヘッダー -->
  <header class="bg-white shadow">
    <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
      <a href="/" class="text-2xl font-bold text-slate-900">
        <span class="text-primary">Cloud</span>Blinker
      </a>
      <nav class="flex items-center space-x-6">
        <span id="user-display-name" class="text-slate-700 font-medium"></span>
        <a href="/client/index.html" class="text-slate-500 hover:text-slate-800">ダッシュボード</a>
        <button id="sign-out-btn" class="text-slate-500 hover:text-slate-800">サインアウト</button>
      </nav>
    </div>
  </header>

  <main class="max-w-3xl mx-auto py-8 px-4 space-y-8">
    <!-- タスク詳細 -->
    <div class="bg-white shadow rounded-lg p-6">
      <h1 id="task-title" class="text-2xl font-bold mb-4">タスク詳細</h1>
      <p id="task-description" class="text-slate-700 mb-4"></p>
      <dl class="space-y-2">
        <div>
          <dt class="text-sm text-slate-500">報酬</dt>
          <dd id="task-reward" class="font-semibold"></dd>
        </div>
        <div>
          <dt class="text-sm text-slate-500">ステータス</dt>
          <dd id="task-status" class="font-semibold"></dd>
        </div>
        <div>
          <dt class="text-sm text-slate-500">作成日時</dt>
          <dd id="task-created" class="text-slate-600"></dd>
        </div>
      </dl>
      <div class="mt-6 flex space-x-4">
        <a href="/client/index.html" class="px-4 py-2 rounded-lg border border-slate-200 hover:bg-slate-50">戻る</a>
        <button id="edit-task-btn" class="px-4 py-2 rounded-lg bg-primary text-white hover:bg-orange-500">編集</button>
      </div>
    </div>
  </main>

  <script type="module">
    import { supabase, requireAuth, signOut } from "/assets/js/app.js";

    // ログイン必須
    const session = await requireAuth();
    const userId = session.user.id;

    // ユーザー名表示
    const { data: profile } = await supabase
      .from("profiles")
      .select("display_name")
      .eq("user_id", userId)
      .single();

    document.getElementById("user-display-name").textContent =
      profile?.display_name || session.user.email;

    // サインアウト処理
    document.getElementById("sign-out-btn").addEventListener("click", async () => {
      await signOut();
    });

    // URLからtask.id取得
    const params = new URLSearchParams(window.location.search);
    const taskId = params.get("id");

    if (!taskId) {
      document.querySelector("main").innerHTML =
        `<p class="text-red-500">タスクが見つかりません。</p>`;
    } else {
      const { data: task, error } = await supabase
        .from("tasks")
        .select("*")
        .eq("id", taskId)
        .single();

      if (error) {
        console.error("Supabase error:", error);
        document.querySelector("main").innerHTML =
          `<p class="text-red-500">タスクの読み込みに失敗しました: ${error.message}</p>`;
      } else {
        document.getElementById("task-title").textContent = task.title;
        document.getElementById("task-description").textContent = task.description || "";
        document.getElementById("task-reward").textContent = `¥${task.reward ?? 0}`;
        document.getElementById("task-status").textContent = task.status;
        document.getElementById("task-created").textContent = new Date(task.created_at).toLocaleString();

        // 編集ボタンの処理（タスク投稿画面にid付きで飛ばす）
        document.getElementById("edit-task-btn").addEventListener("click", () => {
          window.location.href = `/client/tasks-new.html?id=${task.id}`;
        });
      }
    }
  </script>
</body>
</html>
